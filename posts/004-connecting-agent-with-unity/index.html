<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Connecting AI Agent with Unity :: Project:Labs — A human&#39;s attempt to enhance humanity</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Today&amp;rsquo;s Goal In this post, I will try to create a 3D visualization using Unity and connect it to our agent written in python. You may want to read the previous post about Alexander AI concept because we will reuse a lot of the concepts. (In the future, today&amp;rsquo;s version will be referenced as Barton).
Idea I will still continue using the concepts introduced in previous post. However, there is an update that should be done to accommodate remote functionality."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://labs.adamjordan.id/posts/004-connecting-agent-with-unity/" />





<link rel="stylesheet" href="https://labs.adamjordan.id/assets/style.css">


<link rel="stylesheet" href="https://labs.adamjordan.id/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://labs.adamjordan.id/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://labs.adamjordan.id/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Connecting AI Agent with Unity"/>
<meta name="twitter:description" content="Today, I will try to create a 3d visualization using Unity and connect it to our agent written in python. In this devlog, I will write the remote communication module and also the updated AI concepts to support remote functionality."/>



<meta property="og:title" content="Connecting AI Agent with Unity" />
<meta property="og:description" content="Today, I will try to create a 3d visualization using Unity and connect it to our agent written in python. In this devlog, I will write the remote communication module and also the updated AI concepts to support remote functionality." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://labs.adamjordan.id/posts/004-connecting-agent-with-unity/" />
<meta property="article:published_time" content="2019-09-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-19T00:00:00+00:00" /><meta property="og:site_name" content="Project:Labs" />






  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Project:Labs</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/archive">Archive</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/archive">Archive</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://labs.adamjordan.id/posts/004-connecting-agent-with-unity/">Connecting AI Agent with Unity</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            19-09-2019
        </span>
      
      <span class="post-author">— Written by Adam Jordan</span>
      
        <span class="post-read-time">— 9 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://labs.adamjordan.id/tags/artificialconsciousness/">ArtificialConsciousness</a>&nbsp;
        
          #<a href="https://labs.adamjordan.id/tags/artificialintelligence/">ArtificialIntelligence</a>&nbsp;
        
          #<a href="https://labs.adamjordan.id/tags/unity/">Unity</a>&nbsp;
        
          #<a href="https://labs.adamjordan.id/tags/devlog/">Devlog</a>&nbsp;
        
          #<a href="https://labs.adamjordan.id/tags/hunterai/">HunterAI</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      

<h2 id="today-s-goal">Today&rsquo;s Goal</h2>

<p>In this post, I will try to create a 3D visualization using Unity and connect it to our agent written in python.
You may want to read the <a href="https://labs.adamjordan.id/posts/003-creating-simple-intelligent-agent/">previous post</a> about <strong>Alexander</strong> AI concept because we will reuse a lot of the concepts.
(<em>In the future, today&rsquo;s version will be referenced as <strong>Barton</strong></em>).</p>

<p><img src="/post_assets/004/visualization.png" alt="Visualization" /></p>

<h2 id="idea">Idea</h2>

<p>I will still continue using the concepts introduced in <a href="https://labs.adamjordan.id/posts/003-creating-simple-intelligent-agent/">previous post</a>.
However, there is an update that should be done to accommodate remote functionality.</p>

<p>Updated remote agent concepts in python side:</p>

<ul>
<li><p><strong>Remote environment</strong>: remote environment is similar with common environment, a representation that will be perceived and acted upon by architecture.
The differences are:</p>

<ul>
<li>The architecture is not allowed to modify environment state directly.
Action from architecture will be stored at <code>remote_action</code>.</li>
<li>Environment state is updated at every moment / step.
This constant update is required because the Remote environment is actually a representation of the corresponding environment objects in the Unity side.
<br /></li>
</ul></li>

<li><p><strong>Remote architecture</strong>: implementation-wise there is no difference with common architecture.
However, there is an important concept that must be followed by remote architecture during actuating actions.
Remote architecture should never modify environment state directly, instead it should use <code>set_remote_action(action)</code> function to pass the action (<code>remote_action</code>) to the Unity side.
The action will be then realized by the corresponding agent object in the Unity side.</p></li>
</ul>

<p>Next, We have to define a <strong>remote communication module</strong> that allows communication between the python and Unity side.
One of the simplest approach is by serving a <strong>python HTTP server</strong>, and let Unity side send requests and receive responds from the python side.</p>

<p><img src="/post_assets/004/diagram.png" alt="Visualization" /></p>

<p>The HTTP server behavior is defined as follows:</p>

<ul>
<li><p>Endpoint <code>/init</code> will initiate the time, environment and agents.
The initiation procedure is passed as <code>init_function</code> parameter when constructing <code>Remote</code> module.</p></li>

<li><p>Endpoint <code>/step</code> will trigger the <em>world</em> step, moving the time forward.
This endpoint accepts environment state in JSON format.
These actions will be executed:</p>

<ul>
<li>Retrieve the environment state from Unity (from the HTTP body), then update the the python representation of remote environment will update its state accordingly to the passed state.</li>
<li>The agents will start processing the environment, perceiving the environment and producing <code>remote_action</code>.</li>
<li>The <code>remote_action</code> will be returned as HTTP Response. The Unity side will read this action and actuate it accordingly.</li>
<li>Increase time.</li>
</ul></li>
</ul>

<h2 id="the-unity">The Unity</h2>

<p><img src="/post_assets/004/unity-editor.png" alt="Unity Editor" /></p>

<p>For illustration, I show the completed today&rsquo;s Unity project above.
Quick explanation of what is happening in the Unity scene:</p>

<ul>
<li>The blue cube represents the <code>Hunter</code> (player) object.</li>
<li>The red cube represents the <code>Monster</code> object.</li>
<li>The blue cube can spawn <code>Projectile</code> object that will hit the red cube out, making it fall off the ground (then destroyed).</li>
</ul>

<p>The main problem here is how to make <code>Hunter</code> object communicate with our Hunter agent in python?
As discussed in the <em>Idea</em> section, we are going to make the Unity communicate with our python with an HTTP client.</p>

<p>First, put an empty object (<code>Simulator</code>) into our Unity scene.
Then, add <code>HunterSDK</code> and <code>SimulatorScript</code> as components to <code>Simulator</code> object.</p>

<p>The <code>HunterSDK</code> is essentially the code to communicate with our server protocol.
It provides the <code>Initiate()</code> and <code>Step()</code> method.
The <code>initiate()</code> method will send a request to <code>/init</code> endpoint, initiating agents and environment representation in python side.
The <code>Step()</code> method accepts the current environment state in Unity, then send it in JSON format alongside a request to <code>/step</code> endpoint, and then pass the respond to the callback function.
The respond should be containing the action to be actuated.</p>

<pre><code class="language-csharp">// HunterSDK.cs (partial)

public class HunterSDK : MonoBehaviour
{
    public string Host = &quot;http://127.0.0.1:5000/&quot;;

    public void Initiate()
    {
        StartCoroutine(PutRequest(Host + &quot;init&quot;));
    }

    public void Step(State state, Action&lt;StepResponse&gt; callback)
    {
        string stateJson = JsonUtility.ToJson(state);
        StartCoroutine(PutRequest(Host + &quot;step&quot;, stateJson, (res) =&gt;
        {
            StepResponse stepResponse = JsonUtility.FromJson&lt;StepResponse&gt;(res);
            callback(stepResponse);
        }));
    }

    IEnumerator PutRequest(string uri, string data = &quot;{}&quot;, Action&lt;string&gt; callback = null)
    {
        using (UnityWebRequest webRequest = UnityWebRequest.Put(uri, data))
        {
            webRequest.SetRequestHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);
            yield return webRequest.SendWebRequest();
            callback?.Invoke(webRequest.downloadHandler.text);
        }
    }
}
</code></pre>

<p>Next, the <code>SimulatorScript</code> is a behavioural code that should define the behaviour of our agents and environment in Unity side.
Initially in <code>Start()</code>, it will run <code>HunterSDK.Initiate()</code>.
Then, after a fixed interval, it will periodically call the <code>SimulatorScript.Step()</code> funtion.
In this step function, you need to determine the current environment state with Unity functionality (e.g. Calculate the visibility of monster), then pass it to <code>HunterSDK.Step(state)</code>.
Finally, you also need to define what should be done to actuate action accordingly (e.g. Spawn a projectile).</p>

<pre><code class="language-csharp">// SimulatorScript.cs

public class SimulatorScript : MonoBehaviour
{
    public float stepInterval;
    HunterSDK hunterSDK;

    void Start()
    {
		hunterSDK = gameObject.GetComponent&lt;HunterSDK&gt;();
        hunterSDK.Initiate();
        InvokeRepeating(&quot;Step&quot;, stepInterval, stepInterval);
    }

    void Step()
    {
        State state = new State();

        // todo: Sensor code block; fill in state values

        hunterSDK.Step(state, (stepResponse) =&gt;
        {
            AgentAction agentAction = stepResponse.action;

            // todo: Actuator code block; actuate action accordingly

        });
    }
}
</code></pre>

<h2 id="python-code">Python Code</h2>

<h3 id="remote-agent-concept">Remote Agent Concept</h3>

<p>As discussed above, let&rsquo;s define the updated concepts in <code>barton/concept.py</code>.
Note that we will still be reusing the old concepts from <code>alexander/concept.py</code>.</p>

<pre><code class="language-python"># barton/concepts.py

from alexander.concepts import Architecture, Environment


class RemoteArchitecture(Architecture):
    def perceive(self, environment):
        raise NotImplementedError()

    def act(self, environment, action):
        raise NotImplementedError()


class RemoteEnvironment(Environment):
    def __init__(self):
        self.remote_action = None

    def update(self, state):
        self.remote_action = None
        self.update_state(state)

    def set_remote_action(self, action):
        self.remote_action = action

    def get_remote_action(self):
        return self.remote_action

    def update_state(self, state):
        raise NotImplementedError()
</code></pre>

<h3 id="remote-communication-module">Remote Communication Module</h3>

<p>As discussed above, we will be serving a python HTTP server, and let Unity side send requests and receive responds from the python side.
I use <code>flask</code> for its simplicity for running HTTP server.
The HTTP server behavior is defined as follows:</p>

<ul>
<li><p>Endpoint <code>/init</code> will initiate the time, environment and agents.
The initiation procedure is passed as <code>init_function</code> parameter when constructing <code>Remote</code> module.</p></li>

<li><p>Endpoint <code>/step</code> will trigger the <em>world</em> step, moving the time forward.
This endpoint accepts environment state in JSON format.
These actions will be executed:</p>

<ul>
<li>Retrieve the environment state from Unity (from the HTTP body), then update the the python representation of remote environment will update its state accordingly to the passed state.</li>
<li>The agents will start processing the environment, perceiving the environment and producing <code>remote_action</code>.</li>
<li><code>remote_action</code> will be returned as HTTP Response. The Unity side will read this action and actuate its accordingly.</li>
<li>Increase time.</li>
</ul></li>
</ul>

<p>The implementation is as follows:</p>

<pre><code class="language-python"># barton/remote.py

from flask import Flask, jsonify, request
from flask_cors import CORS


class Remote:
    class Controller:
        @staticmethod
        def ping():
            return 'pong'

        @staticmethod
        def init(remote):
            remote.init()
            return jsonify({'ok': True})

        @staticmethod
        def step(remote):
            state = request.get_json()
            response = remote.step(state)
            return jsonify(response)

    def __init__(self, init_function):
        self.init_function = init_function
        self.agents = None
        self.environment = None
        self.time = 0

    def init(self):
        self.environment, self.agents = self.init_function()
        self.time = 0

    def step(self, state):
        self.environment.update(state)
        for agent in self.agents:
            agent.step(self.environment)
        action = self.environment.get_remote_action()
        action_serializable = action.__dict__ if action is not None else None
        self.time += 1
        return {'action': action_serializable}

    def app(self):
        app = Flask(__name__)
        CORS(app)
        app.add_url_rule('/', 'ping', lambda: Remote.Controller.ping())
        app.add_url_rule('/init', 'init', lambda: Remote.Controller.init(self), methods=['PUT'])
        app.add_url_rule('/step', 'step', lambda: Remote.Controller.step(self), methods=['PUT'])
        return app
</code></pre>

<h2 id="writing-hunter-agent-with-the-remote-function-in-python">Writing Hunter Agent with the Remote Function in Python</h2>

<p>First, let&rsquo;s define our hunter architecture using the updated remote architecture concept.
If you notice, the logic is still similar with the previous <code>alexander/architecture.py</code>.
The difference is that instead of changing state <code>environment.monster_visible</code> directly, we will delegate the action to the Unity side through <code>remote_action</code>.</p>

<pre><code class="language-python"># barton/architecture.py

from alexander.concepts import Architecture, Percept
import logging


class HunterRemoteArchitecture(Architecture):
    def perceive(self, environment):
        return Percept({'monster_visible': environment.monster_visible})

    def act(self, environment, action):
        if action.id == 'shoot':
            logging.debug('Pew! Shooting monster')
        environment.set_remote_action(action)
</code></pre>

<p>Next, let&rsquo;s define our hunter environment using the updated remote environment concept.</p>

<pre><code class="language-python"># barton/environment.py

from .concepts import RemoteEnvironment


class HunterRemoteEnvironment(RemoteEnvironment):
    def __init__(self):
        super().__init__()
        self.monster_visible = False

    def update_state(self, state):
        if 'monster_visible' in state:
            self.monster_visible = state['monster_visible']
</code></pre>

<p>Finally, let&rsquo;s write our <code>main</code> file.
In main, we will define our <code>init_function</code> that will instantiate the hunter environment and agent.
Then we will pass the it to <code>Remote</code> module, and run the python remote server.</p>

<pre><code class="language-python"># barton/main.py

from .remote import Remote
from .architecture import HunterRemoteArchitecture
from .environment import HunterRemoteEnvironment
from alexander.program import HunterProgram
from alexander.concepts import Agent

if __name__ == '__main__':
    def init_function():
        environment = HunterRemoteEnvironment()
        program = HunterProgram()
        architecture = HunterRemoteArchitecture()
        agent = Agent(program, architecture)
        return environment, [agent]

    remote = Remote(init_function)
    remote.app().run()
</code></pre>

<p>We can start the python remove server by running the following shell command:</p>

<pre><code class="language-bash">$ python3 -m barton.main 
</code></pre>

<h2 id="hunter-agent-in-unity-side">Hunter Agent in Unity Side</h2>

<p>Remember that we need to write the code to fill in environment state values and actuating agent action in Unity scene.</p>

<p>According to our current Hunter scenario, there is only one state information that we need to attain: monster visibility (<code>monster_visible</code>). Let&rsquo;s just implement that <code>monster_visible</code> is true if the monster object exists and the distance between player object and the monster object is less than 4 unit.</p>

<p>Next, in actuator code block, we check that if the action id is <code>&quot;shoot&quot;</code>, then we call the method <code>playerScript.Shoot()</code>. This method is essentially spawn a projectile and add a big force toward the monster object direction. By the physics of Unity engine, the monster object will be pushed backward by the projectile and it will fall off the ground.</p>

<p>I also add a method <code>SetAIEnabled()</code> to toggle the activation of the AI.
This method is bound to the Toggle UI &ldquo;Enable AI&rdquo;.
There is also a <code>SpawnMonster()</code> method that will be executed when clicking the button &ldquo;Spawn Monster&rdquo;.</p>

<p>The complete Unity Simulator script is as follows:</p>

<pre><code class="language-csharp">// SimulatorScript.cs

public class SimulatorScript : MonoBehaviour
{

    public GameObject monster;
    public GameObject player;
    public float stepInterval;

    bool aiEnabled = true;
    HunterSDK hunterSDK;
    PlayerScript playerScript;


    void Start()
    {
		hunterSDK = gameObject.GetComponent&lt;HunterSDK&gt;();
        playerScript = player.GetComponent&lt;PlayerScript&gt;();
        hunterSDK.Initiate();
        InvokeRepeating(&quot;Step&quot;, stepInterval, stepInterval);
    }

    void Step()
    {
        if (aiEnabled)
        {
            playerScript.ShowThinking(true);
            GameObject monsterGameObject = GameObject.FindGameObjectWithTag(&quot;Monster&quot;);

            State state = new State();
            state.monster_visible = monsterGameObject != null
                &amp;&amp; Vector3.Distance(player.transform.position, monsterGameObject.transform.position) &lt;= 4.0f;

            hunterSDK.Step(state, (stepResponse) =&gt;
            {
                AgentAction agentAction = stepResponse.action;
                if (agentAction.id == &quot;shoot&quot;)
                {
                    playerScript.Shoot();
                }
                Helper.RunLater(this, () =&gt; playerScript.ShowThinking(false), 0.1f);
            });
        }
    }

    public void SpawnMonster()
    {
        GameObject monsterGameObject = GameObject.FindGameObjectWithTag(&quot;Monster&quot;);
        if (monsterGameObject == null)
        {
            Instantiate(monster, new Vector3(2, 6, 0), transform.rotation);
        }
    }

    public void SetAIEnabled(bool isEnabled)
    {
        aiEnabled = isEnabled;
    }
}
</code></pre>

<h2 id="demo-conclusion">Demo &amp; Conclusion</h2>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/P3zoo9JVg3w" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>


<p>Today, we learned how to connect an Intelligent agent with a Unity scene.
The Unity scene acts as a visualization or a frontend for our agent.
In the future, I will keep using visualization in order to better showcase the progress of our agent.
And the agent feels more like a real robot, right?</p>

<h2 id="source-code">Source Code</h2>

<p><a href="https://github.com/adamyordan/hunterAI/tree/master/barton">https://github.com/adamyordan/hunterAI/tree/master/barton</a></p>

    </div>
    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h">Read other posts</span>
          <hr />
        </div>
        <div class="pagination__buttons">
          
          
            <span class="button next">
              <a href="https://labs.adamjordan.id/posts/003-creating-simple-intelligent-agent/">
                <span class="button__text">Creating Simple Intelligent Agent: HunterAI</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    

    
    <br><br>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "project-labs" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">Project:Labs</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2019 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://labs.adamjordan.id/assets/main.js"></script>
<script src="https://labs.adamjordan.id/assets/prism.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
});
</script>


      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-124774114-3', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
